flowchart LR
  %% ============================
  %% USER SIDE
  %% ============================
  subgraph USERS["ðŸ‘¥ Users / Clients"]
    U_WEB["ðŸ’» Web UI (free-ebay)"]
    U_MOBILE["ðŸ“± Mobile UI"]
    X_WEB["ðŸ–¥ Tracking UI (xiaoping)"]
    X_OPS["ðŸ›  Ops UI (xiaoping)"]
  end

  %% ============================
  %% EDGE / API
  %% ============================
  subgraph EDGE["ðŸŒ Edge / API"]
    APIGW["ðŸ›¡ API Gateway (Envoy/Kong)"]
    CDN["â˜ï¸ CDN / S3"]
    AUTHGW["ðŸ”‘ Auth Proxy (JWT/OIDC)"]
    XI_APIGW["ðŸ›¡ Xi API Gateway (Envoy/Kong)"]
    XI_CDN["â˜ï¸ Xi CDN / S3"]
    XI_AUTHGW["ðŸ”‘ Xi Auth Proxy (JWT/OIDC)"]
  end

  %% ============================
  %% FREE-EBAY SERVICES + PLATFORM
  %% ============================
  subgraph EBAY["free-ebay ecosystem + platform"]
    subgraph FE_SERVICES["ðŸŸ¦ free-ebay Services"]
      FE_Product["ðŸ“¦ Product Service\n(publishes events)"]
      FE_Catalog["ðŸ—‚ Catalog Service\n(CQRS -> Elasticsearch)"]
      FE_Search["ðŸ” Search Service\n(Elasticsearch)"]
      FE_Inventory["ðŸ¬ Inventory Service"]
      FE_Checkout["ðŸ›’ Checkout Service\n(validates & prepares orders)"]
      FE_Order["ðŸ“ƒ Order Service\n(CQRS / Saga)"]
      FE_Payment["ðŸ’³ Payment Service (Stripe wrapper)"]
      FE_Crypto["ðŸª™ Crypto Service\n(gRPC streaming)"]
      FE_Smart["âš– Smart Contract Service\n(Solidity)"]
      FE_User["ðŸ‘¤ User Service"]
      FE_Auth["ðŸ” Auth Service (OIDC)"]
      FE_Notifications["âœ‰ï¸ Email/SMS Service"]
      FE_AI["ðŸ¤– AI Service (LangChain)"]
      FE_Audit["ðŸ“‹ Audit / Compliance"]
    end

    subgraph FE_INFRA["ðŸ–¥ free-ebay Platform / Infra"]
      KAFKA_FE[(ðŸŸ  Kafka / MSK - FE)]
      ES_FE[(ðŸŸ¢ Elasticsearch Cluster - FE)]
      REDIS_FE[(ðŸŸ£ Redis Cache / Rate-limit - FE)]
      POSTGRES_FE[(ðŸŸ¤ Postgres per service - FE)]
      MONGO_FE[(âš« Mongo / Event Store - FE)]
      OTEL_FE["ðŸ“Š OpenTelemetry"]
      PROM_FE["ðŸ“ˆ Prometheus"]
      GRAF_FE["ðŸ“Š Grafana"]
      VAULT_FE["ðŸ”’ Vault / Secrets"]
      K8S_FE["â˜¸ï¸ Kubernetes Cluster"]
    end
  end

  %% ============================
  %% XIAOPING-EXPRESS SERVICES + PLATFORM
  %% ============================
  subgraph XI["xiaoping-express ecosystem + platform"]
    subgraph XI_SERVICES["ðŸŸ© xiaoping Services"]
      XI_PublicAPI["ðŸŒ Public API"]
      XI_Parcel["ðŸ“¦ Parcel Service\n(Event Sourcing + CQRS)"]
      XI_Shipment["ðŸšš Shipment Service"]
      XI_Delivery["ðŸ Delivery Service"]
      XI_Notification["ðŸ”” Notification Service"]
      XI_CustomerSupport["ðŸ§‘â€ðŸ’» Customer Support Service"]
      XI_Analytics["ðŸ“Š Analytics / Reporting Service"]
      XI_User["ðŸ‘¤ User Service"]
      XI_Auth["ðŸ” Auth Service"]
      XI_Audit["ðŸ“‹ Delivery Audit Service"]
    end

    subgraph XI_INFRA["ðŸ–¥ xiaoping Platform / Infra"]
      KAFKA_XI[(ðŸŸ  Kafka / MSK - XI)]
      ES_XI[(ðŸŸ¢ Elasticsearch Cluster - XI)]
      REDIS_XI[(ðŸŸ£ Redis Cache / Rate-limit - XI)]
      POSTGRES_XI[(ðŸŸ¤ Postgres per service - XI)]
      MONGO_XI[(âš« Mongo / Event Store - XI)]
      OTEL_XI["ðŸ“Š OpenTelemetry"]
      PROM_XI["ðŸ“ˆ Prometheus"]
      GRAF_XI["ðŸ“Š Grafana"]
      VAULT_XI["ðŸ”’ Vault / Secrets"]
      K8S_XI["â˜¸ï¸ Kubernetes Cluster"]
    end
  end

  %% ============================
  %% USER FLOWS
  %% ============================
  U_WEB -->|HTTPS| APIGW
  U_MOBILE -->|HTTPS| APIGW
  X_WEB -->|HTTPS| XI_APIGW
  X_OPS -->|HTTPS| XI_APIGW

  %% API Gateway -> free-ebay
  APIGW --> FE_Product
  APIGW --> FE_Catalog
  APIGW --> FE_Search
  APIGW --> FE_User
  APIGW --> FE_Checkout
  APIGW --> FE_Order
  APIGW --> FE_Payment
  APIGW --> FE_Crypto
  APIGW --> FE_Auth

  %% Checkout & Order flow
  FE_Checkout --> FE_Product
  FE_Checkout --> FE_Inventory
  FE_Checkout --> FE_Order
  FE_Order --> FE_Payment
  FE_Payment --> FE_Order

  %% Event flows FE
  FE_Product -->|publishes product events| KAFKA_FE
  FE_Order -->|publishes order events| KAFKA_FE
  FE_Inventory -->|publishes inventory events| KAFKA_FE
  FE_Catalog -->|publishes catalog events| KAFKA_FE
  FE_Search <-->|consumes events| KAFKA_FE
  FE_AI -->|consumes events| KAFKA_FE
  FE_Crypto --> FE_Smart
  FE_Crypto -->|publishes tx events| KAFKA_FE

  %% Cross-ecosystem call: free-ebay -> xiaoping public API
  FE_Order -->|REST / gRPC call| XI_PublicAPI
  XI_PublicAPI --> XI_Parcel

  %% XI internal flows
  XI_APIGW --> XI_Parcel
  XI_APIGW --> XI_Shipment
  XI_APIGW --> XI_Delivery
  XI_APIGW --> XI_Notification
  XI_APIGW --> XI_CustomerSupport
  XI_APIGW --> XI_User
  XI_APIGW --> XI_Auth

  %% XI event flows
  XI_Parcel -->|publishes shipment events| KAFKA_XI
  XI_Shipment -->|publishes routing events| KAFKA_XI
  XI_Delivery -->|publishes delivery events| KAFKA_XI
  KAFKA_XI --> XI_Audit
  XI_Notification -->|consumes events| KAFKA_XI
  XI_CustomerSupport -->|consumes events| KAFKA_XI
  XI_Analytics -->|consumes events| KAFKA_XI

  %% Observability
  FE_Checkout --> OTEL_FE
  FE_Order --> OTEL_FE
  FE_Product --> OTEL_FE
  FE_Inventory --> OTEL_FE
  FE_Catalog --> OTEL_FE
  FE_Search --> OTEL_FE
  FE_AI --> OTEL_FE
  FE_Crypto --> OTEL_FE
  OTEL_FE --> PROM_FE --> GRAF_FE

  XI_Parcel --> OTEL_XI
  XI_Shipment --> OTEL_XI
  XI_Delivery --> OTEL_XI
  XI_Notification --> OTEL_XI
  XI_CustomerSupport --> OTEL_XI
  XI_Analytics --> OTEL_XI
  OTEL_XI --> PROM_XI --> GRAF_XI

  %% Databases & Storage
  FE_Search --> ES_FE
  FE_Product --> POSTGRES_FE
  FE_Checkout --> POSTGRES_FE
  FE_Order --> POSTGRES_FE
  FE_User --> POSTGRES_FE
  FE_Inventory --> POSTGRES_FE
  XI_Parcel --> MONGO_XI
  XI_Shipment --> POSTGRES_XI
  XI_Delivery --> POSTGRES_XI
  XI_CustomerSupport --> POSTGRES_XI
  XI_Analytics --> POSTGRES_XI

  %% Redis / Vault
  ALL_REDIS_FE["All FE services using Redis"] -.-> REDIS_FE
  ALL_SERVICES_FE["All FE microservices"] -.-> VAULT_FE
  ALL_REDIS_XI["All XI services using Redis"] -.-> REDIS_XI
  ALL_SERVICES_XI["All XI microservices"] -.-> VAULT_XI

  %% Styles
  classDef feStyle fill:#1A73E8,stroke:#155fa0,stroke-width:2px,color:#fff;
  classDef xiStyle fill:#2E7D32,stroke:#1b4d1b,stroke-width:2px,color:#fff;
  class USERS fill:#f4f4f4,stroke:#999,stroke-width:1px;
  class EDGE fill:#ffe0b2,stroke:#ff9800,stroke-width:2px;

  class EBAY,FE_SERVICES,FE_INFRA feStyle;
  class XI,XI_SERVICES,XI_INFRA xiStyle;
